/*
 * -------------------------------------------------
 *  University of Hawaii at Manoa cluster config file
 * -------------------------------------------------
 *
 */

params {
    db_dir = "${PWD}/databases"
    script_dir = "${PWD}/scripts"

    referenceAln = db_dir + "/silva.nr_v132.align"
    referenceTax = db_dir + "/silva.full_v132.tax"
    uniteDB = db_dir + "/unite_all_eukaryotes.fasta"

    mothur_path = "${PWD}/mothur_1-43"
    itsxpress_path = "${PWD}/itsxpress_bin"
}

env{
    PYTHONPATH = params.script_dir + ":${PWD}/python-packages:${PYTHONPATH}"
    R_LIBS_USER = "${PWD}/R-packages"
}

executor{
    jobName = {"$task.tag"}
    queueSize = 40
}

tower {
    enabled = false
}

process {
    executor = 'slurm'
    stageInMode = 'symlink'
    stageOutMode = 'rsync'
    queue = 'shared,shared-long,exclusive,exclusive-long,kill-shared,kill-exclusive'
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'terminate' }
    maxRetries = 2

   withLabel: low_computation {
        cpus = 3
        memory = 16.GB
        time = 1.h
   }

   withLabel: medium_computation {
        cpus = 5
        memory = {30.GB * task.attempt}
        time = {1.h * task.attempt}
   }

   withLabel: high_computation {
        cpus = {10*(task.attempt==1 ? 1 : 0) + 19*(task.attempt>1 ? 1 : 0)}
        memory = {60.GB*(task.attempt==1 ? 1 : 0) + 120.GB*(task.attempt==2 ? 1 : 0) + 500.GB*(task.attempt==3 ? 1 : 0)}
        time = {3.h*(task.attempt==1 ? 1 : 0) + 12.h*(task.attempt==2 ? 1 : 0) + 24.h*(task.attempt==3 ? 1 : 0)}
   }

   withLabel: r_script {
        module="lang/R/3.5.1-intel-2018.5.274-Python-2.7.15"
   }

   withLabel: python_script {
        module = "lang/Python/3.7.2-GCCcore-8.2.0"
   }

   withLabel: mothur_script {
        beforeScript = "export PATH=${PATH}:${params.mothur_path}"
   }

   withLabel: require_vsearch {
        module="bio/VSEARCH/2.11.1"
   }

   withName: QcFilter {
        module="bio/FASTX-Toolkit/0.0.14"
   }

   withName: ExtractITS {
        module=[
        "lang/Python/3.7.2-GCCcore-8.2.0",
        "bio/VSEARCH/2.9.1-foss-2018b",
        "bio/HMMER/3.2.1-foss-2018b",
        "bio/BBtools/38.46"]
        beforeScript = "export PATH=${PATH}:${params.itsxpress_path}"
   }
}