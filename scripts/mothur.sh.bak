#!/usr/bin/env bash

for arg in "$@"
do
    case $arg in	
    --step=*)
	step="${arg#*=}" ;;
    
    --pairId=*)
	pairId="${arg#*=}" ;;

    --fwdFastq=*)
	fwdFastq="${arg#*=}"
	noGzRad=`basename $fwdFastq .gz`
	ext="${noGzRad##*.}"
	fqRad=`basename $noGzRad .$ext`;;

    --revFastq=*)
	revFastq="${arg#*=}" ;;

    --inputFasta=*)
	inputFasta="${arg#*=}"
	noGzRad=`basename $inputFasta .gz`
	ext="${noGzRad##*.}"
	faRad=`basename $noGzRad .$ext`;;

    --inputNames=*)
	inputNames="${arg#*=}"
	namesRad=`basename $inputNames .names`;;
		       
    --optimize=*)
	optimize="${arg#*=}" ;;

    --criteria=*)
	criteria="${arg#*=}" ;;

    --refAln=*)
	refAln="${arg#*=}" ;;
    
    --refTax=*)
	refTax="${arg#*=}" ;;

    *)
	echo "$arg: Unknown option";;    
    esac
done

out="${pairId}.${step}"

if [ $step == "merging" ]; then
    cmd=("make.contigs(ffastq=${fwdFastq}, rfastq=${revFastq})")
    outputs_mothur=("${fqRad}.trim.contigs.fasta")
    outputs_renamed=("${out}.fasta")
    
elif [ $step == "filter" ]; then
    if [ -z ${inputNames} ]; then
	cmd=("screen.seqs(fasta=${inputFasta}, optimize=${optimize}, criteria=${criteria})")
	output_mothur=("${faRad}.good.fasta")
	output_renamed=("${out}.fasta")
    else
	cmd=("screen.seqs(fasta=${inputFasta}, name=${inputNames}, optimize=${optimize}, criteria=${criteria})")
	outputs_mothur=("${namesRad}.good.names" "${faRad}.good.fasta")
	outputs_renamed=("${out}.names" "${out}.fasta")
    fi
	 
elif [ $step == "summary" ]; then
    cmd=("summary.seqs(fasta=${inputFasta})")
    outputs_mothur=("${faRad}.summary")
    outputs_renamed=("${out}.summary")
    
elif [ $step == "dereplication" ]; then
    cmd=("unique.seqs(fasta=${inputFasta})")
    output_mothur=("${faRad}.unique.fasta" "${faRad}.names")
    output_renamed=("${out}.fasta" "${out}.names")
    
elif [ $step == "MSA" ]; then
    cmd=("align.seqs(fasta=${inputFasta},reference=${refAln}) ; "
	 "filter.seqs(fasta=${faRad}.align)")
    output_mothur=("${faRad}.filter.fasta")
    output_renamed=("${out}.fasta")

elif [ $step == "chimera" ]; then
    cmd=("chimera.vsearch(fasta=${inputFasta}, name=${inputNames},dereplicate=t) ; "
	 "remove.seqs(fasta=${inputFasta}, name=${inputNames},accnos=${faRad}.denovo.vsearch.accnos)")
    output_mothur=("${faRad}.pick.fasta" "${nameRad}.pick.names")
    output_renamed=("${out}.fasta" "${out}.names")

elif [ $step == "TaxaFilter" ]; then
    suffixTax=`basename ${refTax} .tax`.wang.taxonomy
    
    cmd=("classify.seqs(fasta=${inputFasta}, name=${inputNames}, template=${refAln}, taxonomy=${refTax}) ; "
	 "remove.lineage(taxonomy=${faRad}${suffixTax}, name=${inputNames}, fasta=${inputFasta},taxon=-unknown)")
    output_mothur=("${nameRad}.pick.names" "${faRad}.pick.fasta")
    output_renamed=("${out}.names" "${out}.fasta")
    
#elif [ $step == "Classification" ]; then
    
#	 "rename.file(input=${faRad},new=${out})"
fi;

res=$( IFS=$' '; echo "${cmd[*]}" )

mothur "#${res}"

for i in 1..${#output_mothur[@]}
do
    mv $output_mothur[$i] $output_renamed[$i]
done
